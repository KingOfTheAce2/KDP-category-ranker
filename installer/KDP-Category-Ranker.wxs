<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <Package Id="*" 
           Name="KDP Category Ranker" 
           Language="1033" 
           Version="1.0.0" 
           Manufacturer="KDP Tools LLC"
           UpgradeCode="12345678-1234-1234-1234-123456789012"
           Scope="perMachine">
    
    <SummaryInformation 
      Keywords="KDP,Amazon,Category,Bestseller,Publishing" 
      Description="Find the best KDP categories and plan your path to bestseller status" 
      Manufacturer="KDP Tools LLC"/>
    
    <!-- Major upgrade settings -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of KDP Category Ranker is already installed." />
    
    <!-- Media template for embedding files -->
    <MediaTemplate EmbedCab="yes" />
    
    <!-- UI Settings -->
    <ui:WixUI Id="WixUI_Minimal" />
    <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" />
    
    <!-- Main feature -->
    <Feature Id="ProductFeature" Title="KDP Category Ranker" Level="1">
      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="ConfigFiles" />
      <ComponentRef Id="SampleData" />
      <ComponentRef Id="StartMenuShortcut" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="FileAssociation" />
    </Feature>

    <!-- Installation directory structure -->
    <StandardDirectory Id="ProgramFilesFolder">
      <Directory Id="INSTALLFOLDER" Name="KDP Category Ranker">
        
        <!-- Main application files -->
        <Component Id="MainExecutable">
          <File Id="MainExe" 
                Source="$(var.PublishDir)\KDP-CATEGORY-RANKERApp.exe"
                Name="KDP-CATEGORY-RANKERApp.exe"
                KeyPath="yes" />
          
          <!-- Optional: Include any additional DLLs if not using single-file -->
          <!-- <File Source="$(var.PublishDir)\*.dll" /> -->
        </Component>

        <!-- Configuration files -->
        <Component Id="ConfigFiles">
          <File Source="$(var.PublishDir)\appsettings.json" />
        </Component>

        <!-- Sample data directory -->
        <Directory Id="SampleDataDir" Name="SampleData">
          <Component Id="SampleData">
            <File Source="$(var.SampleDataDir)\sample-categories.json" />
            <File Source="$(var.SampleDataDir)\sample-keywords.json" />
            <File Source="$(var.SampleDataDir)\sample-books.json" />
          </Component>
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Start Menu shortcuts -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="KDP Category Ranker">
        <Component Id="StartMenuShortcut">
          <Shortcut Id="ApplicationStartMenuShortcut"
                    Name="KDP Category Ranker"
                    Description="Find the best KDP categories for your book"
                    Target="[INSTALLFOLDER]KDP-CATEGORY-RANKERApp.exe"
                    WorkingDirectory="INSTALLFOLDER"
                    Icon="AppIcon" />
          
          <!-- Help shortcut -->
          <Shortcut Id="HelpStartMenuShortcut"
                    Name="KDP Category Ranker - User Guide"
                    Description="Open the user guide"
                    Target="[INSTALLFOLDER]UserGuide.pdf"
                    WorkingDirectory="INSTALLFOLDER" />
          
          <!-- Uninstall shortcut -->
          <Shortcut Id="UninstallProduct"
                    Name="Uninstall KDP Category Ranker"
                    Description="Uninstalls KDP Category Ranker"
                    Target="[SystemFolder]msiexec.exe"
                    Arguments="/x [ProductCode]" />
          
          <RemoveFolder Id="CleanUpStartMenu" Directory="ApplicationProgramsFolder" On="uninstall" />
          <RegistryValue Root="HKCU" 
                        Key="Software\KDPCategoryRanker" 
                        Name="installed" 
                        Type="integer" 
                        Value="1" 
                        KeyPath="yes" />
        </Component>
      </Directory>
    </StandardDirectory>

    <!-- Desktop shortcut -->
    <StandardDirectory Id="DesktopFolder">
      <Component Id="DesktopShortcut">
        <Shortcut Id="ApplicationDesktopShortcut"
                  Name="KDP Category Ranker"
                  Description="Find the best KDP categories for your book"
                  Target="[INSTALLFOLDER]KDP-CATEGORY-RANKERApp.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="AppIcon" />
        <RegistryValue Root="HKCU" 
                      Key="Software\KDPCategoryRanker" 
                      Name="desktop" 
                      Type="integer" 
                      Value="1" 
                      KeyPath="yes" />
      </Component>
    </StandardDirectory>

    <!-- File associations for .kdp and .rocketproj files -->
    <Component Id="FileAssociation" Directory="INSTALLFOLDER">
      <!-- .kdp file association -->
      <RegistryValue Root="HKCR" Key=".kdp" Value="KDPCategoryRanker.Project" Type="string" />
      <RegistryValue Root="HKCR" Key=".kdp" Name="Content Type" Value="application/kdp-project" Type="string" />
      
      <!-- .rocketproj file association (Publisher Rocket compatibility) -->
      <RegistryValue Root="HKCR" Key=".rocketproj" Value="KDPCategoryRanker.Project" Type="string" />
      
      <!-- Program registration -->
      <RegistryValue Root="HKCR" Key="KDPCategoryRanker.Project" Value="KDP Category Ranker Project" Type="string" />
      <RegistryValue Root="HKCR" Key="KDPCategoryRanker.Project\DefaultIcon" 
                     Value="[INSTALLFOLDER]KDP-CATEGORY-RANKERApp.exe,0" Type="string" />
      <RegistryValue Root="HKCR" Key="KDPCategoryRanker.Project\shell\open\command" 
                     Value="&quot;[INSTALLFOLDER]KDP-CATEGORY-RANKERApp.exe&quot; &quot;%1&quot;" Type="string" />
      
      <!-- Add to "Open with" menu -->
      <RegistryValue Root="HKCR" Key="Applications\KDP-CATEGORY-RANKERApp.exe\shell\open\command" 
                     Value="&quot;[INSTALLFOLDER]KDP-CATEGORY-RANKERApp.exe&quot; &quot;%1&quot;" Type="string" />
      <RegistryValue Root="HKCR" Key="Applications\KDP-CATEGORY-RANKERApp.exe\SupportedTypes" 
                     Name=".kdp" Value="" Type="string" />
      <RegistryValue Root="HKCR" Key="Applications\KDP-CATEGORY-RANKERApp.exe\SupportedTypes" 
                     Name=".rocketproj" Value="" Type="string" />
    </Component>

    <!-- Application icon -->
    <Icon Id="AppIcon" SourceFile="$(var.ResourceDir)\app-icon.ico" />
    
    <!-- Add to Programs and Features -->
    <Property Id="ARPPRODUCTICON" Value="AppIcon" />
    <Property Id="ARPHELPLINK" Value="https://github.com/your-repo/kdp-category-ranker" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/your-repo/kdp-category-ranker" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
    
    <!-- Auto-launch after installation -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" 
              Value="Launch KDP Category Ranker" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    
    <!-- Custom action to launch application -->
    <CustomAction Id="LaunchApplication"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[INSTALLFOLDER]KDP-CATEGORY-RANKERApp.exe"
                  Impersonate="yes"
                  Return="asyncNoWait" />
    
    <InstallExecuteSequence>
      <Custom Action="LaunchApplication" After="InstallFinalize">
        <![CDATA[(&ProductFeature=3) AND NOT Installed AND (WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1)]]>
      </Custom>
    </InstallExecuteSequence>
    
    <!-- Prerequisites check -->
    <Property Id="NETFRAMEWORK48">
      <RegistrySearch Id="NetFramework48"
                      Root="HKLM"
                      Key="SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full"
                      Name="Release"
                      Type="raw" />
    </Property>
    
    <!-- Launch condition for .NET -->
    <Launch Condition="Installed OR (NETFRAMEWORK48 &gt;= 528040)"
            Message="This application requires .NET Framework 4.8 or higher. Please install it before installing KDP Category Ranker." />
  </Package>
</Wix>