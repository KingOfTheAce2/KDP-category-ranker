<UserControl x:Class="KDP_CATEGORY_RANKERApp.Views.CategoryRecommenderView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:vm="clr-namespace:KDP_CATEGORY_RANKERApp.ViewModels">

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="📚 Category Recommender" FontSize="24" FontWeight="Bold"/>
            <TextBlock Text="Find the best KDP categories for your book and plan your path to bestseller status" 
                      FontSize="14" Foreground="{DynamicResource MahApps.Brushes.Gray1}" Margin="0,4,0,0"/>
        </StackPanel>

        <!-- Input Section -->
        <Expander Grid.Row="1" Header="📝 Book Details &amp; Goals" IsExpanded="True" Margin="0,0,0,16">
            <Grid Margin="16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Row 1: Basic Book Info -->
                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,8,16">
                    <TextBlock Text="Book Title *" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding BookTitle, UpdateSourceTrigger=PropertyChanged}" 
                            mah:TextBoxHelper.Watermark="Enter your book title"/>
                </StackPanel>

                <StackPanel Grid.Row="0" Grid.Column="1" Margin="8,0,8,16">
                    <TextBlock Text="Book Format" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <ComboBox ItemsSource="{Binding BookFormats}" 
                             SelectedItem="{Binding SelectedFormat}"/>
                </StackPanel>

                <StackPanel Grid.Row="0" Grid.Column="2" Margin="8,0,0,16">
                    <TextBlock Text="Target Market" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <ComboBox ItemsSource="{Binding Markets}" 
                             SelectedItem="{Binding SelectedMarket}"/>
                </StackPanel>

                <!-- Row 2: Keywords and Description -->
                <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,0,8,16">
                    <TextBlock Text="Keywords (comma-separated)" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding Keywords, UpdateSourceTrigger=PropertyChanged}" 
                            mah:TextBoxHelper.Watermark="romance, love story, contemporary, etc."/>
                </StackPanel>

                <StackPanel Grid.Row="1" Grid.Column="2" Margin="8,0,0,16">
                    <TextBlock Text="Book Description" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding BookDescription, UpdateSourceTrigger=PropertyChanged}" 
                            Height="60" TextWrapping="Wrap" AcceptsReturn="True"
                            mah:TextBoxHelper.Watermark="Brief description of your book..."/>
                </StackPanel>

                <!-- Row 3: Goals and Constraints -->
                <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,8,16">
                    <TextBlock Text="Book Price ($)" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <mah:NumericUpDown Value="{Binding BookPrice}" Minimum="0.99" Maximum="999.99" 
                                      StringFormat="C2" Interval="0.50"/>
                </StackPanel>

                <StackPanel Grid.Row="2" Grid.Column="1" Margin="8,0,8,16">
                    <TextBlock Text="Max Daily Sales Target" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <mah:NumericUpDown Value="{Binding MaxDailySalesTarget}" Minimum="1" Maximum="1000" 
                                      mah:TextBoxHelper.Watermark="Realistic daily sales you can achieve"/>
                </StackPanel>

                <StackPanel Grid.Row="2" Grid.Column="2" Margin="8,0,0,16">
                    <TextBlock Text="Planned Release Date" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <DatePicker SelectedDate="{Binding PlannedReleaseDate}"/>
                </StackPanel>

                <!-- Row 4: Filters -->
                <StackPanel Grid.Row="3" Grid.Column="0" Margin="0,0,8,0">
                    <TextBlock Text="Max Difficulty Level" FontWeight="SemiBold" Margin="0,0,0,4"/>
                    <ComboBox ItemsSource="{Binding DifficultyLevels}" 
                             SelectedItem="{Binding MaxDifficultyLevel}"/>
                </StackPanel>

                <StackPanel Grid.Row="3" Grid.Column="1" Margin="8,0,8,0" Orientation="Horizontal">
                    <CheckBox Content="Include High Competition" IsChecked="{Binding IncludeHighCompetition}" 
                             VerticalAlignment="Center" Margin="0,24,16,0"/>
                    <CheckBox Content="Exclude Ghost Categories" IsChecked="{Binding ExcludeGhostCategories}" 
                             VerticalAlignment="Center" Margin="0,24,0,0"/>
                </StackPanel>

                <StackPanel Grid.Row="3" Grid.Column="2" Margin="8,0,0,0" Orientation="Horizontal" 
                           HorizontalAlignment="Right">
                    <Button Content="🔍 Find Categories" Command="{Binding SearchRecommendationsCommand}" 
                           IsEnabled="{Binding IsSearching, Converter={StaticResource BooleanToVisibilityConverter}}"
                           Style="{DynamicResource MahApps.Styles.Button.Square.Accent}" 
                           Margin="0,20,8,0" Padding="16,8"/>
                    <Button Content="⚡ Show Easiest" Command="{Binding LoadEasiestCategoriesCommand}" 
                           Style="{DynamicResource MahApps.Styles.Button.Square}"
                           Margin="0,20,0,0" Padding="16,8"/>
                </StackPanel>
            </Grid>
        </Expander>

        <!-- Results Section -->
        <TabControl Grid.Row="2" Style="{DynamicResource MahApps.Styles.TabControl}">
            <!-- Recommendations Tab -->
            <TabItem Header="🎯 Recommended Categories">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Recommendations List -->
                    <DataGrid Grid.Column="0" ItemsSource="{Binding RecommendationsView}" 
                             SelectedItem="{Binding SelectedRecommendation}"
                             Style="{DynamicResource ModernDataGridStyle}" Margin="0,0,8,0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Category" Binding="{Binding Breadcrumb}" Width="*"/>
                            <DataGridTextColumn Header="Score" Binding="{Binding RecommendationScore}" Width="60"/>
                            <DataGridTextColumn Header="Difficulty" Binding="{Binding DifficultyLevel}" Width="80"/>
                            <DataGridTextColumn Header="Sales for #1" Binding="{Binding DailySalesForBestseller}" Width="80"/>
                            <DataGridTextColumn Header="Sales for Top 10" Binding="{Binding DailySalesForTop10}" Width="80"/>
                            <DataGridTextColumn Header="Avg Price" Binding="{Binding AveragePrice, StringFormat=C2}" Width="70"/>
                            <DataGridTextColumn Header="Trend" Binding="{Binding SalesVolumetrend}" Width="70"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Category Analysis Panel -->
                    <Border Grid.Column="1" Style="{DynamicResource ChartContainerStyle}" Margin="8,0,0,0">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <TextBlock Text="📊 Category Analysis" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"/>
                                
                                <ContentControl Content="{Binding SelectedRecommendation}">
                                    <ContentControl.ContentTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock Text="{Binding Breadcrumb}" FontWeight="SemiBold" 
                                                          TextWrapping="Wrap" Margin="0,0,0,8"/>
                                                
                                                <!-- Difficulty Indicator -->
                                                <Border Style="{DynamicResource MetricTileStyle}" Margin="0,0,0,8">
                                                    <StackPanel>
                                                        <TextBlock Text="Difficulty Level" FontSize="12" Foreground="Gray"/>
                                                        <TextBlock Text="{Binding DifficultyLevel}" FontSize="16" FontWeight="Bold"/>
                                                        <ProgressBar Value="{Binding DifficultyScore}" Maximum="100" 
                                                                   Height="8" Margin="0,4,0,0"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Bestseller Requirements -->
                                                <Border Style="{DynamicResource MetricTileStyle}" Margin="0,0,0,8">
                                                    <StackPanel>
                                                        <TextBlock Text="Daily Sales Requirements" FontSize="12" Foreground="Gray"/>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="#1: " FontSize="10"/>
                                                            <TextBlock Text="{Binding DailySalesForBestseller}" FontWeight="Bold"/>
                                                        </StackPanel>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="Top 10: " FontSize="10"/>
                                                            <TextBlock Text="{Binding DailySalesForTop10}" FontWeight="Bold"/>
                                                        </StackPanel>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="Top 50: " FontSize="10"/>
                                                            <TextBlock Text="{Binding DailySalesForTop50}" FontWeight="Bold"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Revenue Potential -->
                                                <Border Style="{DynamicResource MetricTileStyle}" Margin="0,0,0,8">
                                                    <StackPanel>
                                                        <TextBlock Text="Revenue Potential" FontSize="12" Foreground="Gray"/>
                                                        <TextBlock Text="{Binding EstimatedMonthlyRevenue, StringFormat=C0}" 
                                                                  FontSize="16" FontWeight="Bold"/>
                                                        <TextBlock Text="Monthly at bestseller" FontSize="10" Foreground="Gray"/>
                                                    </StackPanel>
                                                </Border>

                                                <!-- Market Info -->
                                                <Border Style="{DynamicResource MetricTileStyle}">
                                                    <StackPanel>
                                                        <TextBlock Text="Market Information" FontSize="12" Foreground="Gray"/>
                                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                                            <TextBlock Text="Avg Price: " FontSize="10"/>
                                                            <TextBlock Text="{Binding AveragePrice, StringFormat=C2}" FontWeight="Bold"/>
                                                        </StackPanel>
                                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                                            <TextBlock Text="KU %: " FontSize="10"/>
                                                            <TextBlock Text="{Binding KindleUnlimitedPercentage, StringFormat=P0}" FontWeight="Bold"/>
                                                        </StackPanel>
                                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                                            <TextBlock Text="Big Pub %: " FontSize="10"/>
                                                            <TextBlock Text="{Binding BigPublisherPercentage, StringFormat=P0}" FontWeight="Bold"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </Border>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ContentControl.ContentTemplate>
                                </ContentControl>
                            </StackPanel>
                        </ScrollViewer>
                    </Border>
                </Grid>
            </TabItem>

            <!-- Easiest Categories Tab -->
            <TabItem Header="⚡ Easiest Categories">
                <DataGrid ItemsSource="{Binding EasiestCategoriesView}" 
                         Style="{DynamicResource ModernDataGridStyle}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Category" Binding="{Binding Breadcrumb}" Width="*"/>
                        <DataGridTextColumn Header="Difficulty" Binding="{Binding DifficultyLevel}" Width="80"/>
                        <DataGridTextColumn Header="Sales for #1" Binding="{Binding DailySalesForBestseller}" Width="80"/>
                        <DataGridTextColumn Header="Sales for Top 10" Binding="{Binding DailySalesForTop10}" Width="80"/>
                        <DataGridTextColumn Header="Avg Price" Binding="{Binding AveragePrice, StringFormat=C2}" Width="70"/>
                        <DataGridCheckBoxColumn Header="Ghost" Binding="{Binding IsGhostCategory}" Width="50"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Bestseller Planning Tab -->
            <TabItem Header="📈 Bestseller Planning">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ContentControl Content="{Binding BestsellerPlan}" Margin="16">
                        <ContentControl.ContentTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <TextBlock Text="🎯 Path to Bestseller Status" FontSize="18" FontWeight="Bold" Margin="0,0,0,16"/>
                                    
                                    <TextBlock Text="{Binding CategoryName}" FontSize="14" FontWeight="SemiBold" 
                                              TextWrapping="Wrap" Margin="0,0,0,16"/>

                                    <!-- Current Requirements -->
                                    <Border Style="{DynamicResource ChartContainerStyle}" Margin="0,0,0,16">
                                        <StackPanel>
                                            <TextBlock Text="📊 Current Requirements" FontWeight="Bold" Margin="0,0,0,8"/>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <Border Grid.Column="0" Style="{DynamicResource MetricTileStyle}" Margin="0,0,4,0">
                                                    <StackPanel>
                                                        <TextBlock Text="Bestseller (#1)" FontSize="12" Foreground="Gray"/>
                                                        <TextBlock Text="{Binding CurrentDailySalesForBestseller}" 
                                                                  FontSize="20" FontWeight="Bold"/>
                                                        <TextBlock Text="daily sales" FontSize="10" Foreground="Gray"/>
                                                    </StackPanel>
                                                </Border>
                                                
                                                <Border Grid.Column="1" Style="{DynamicResource MetricTileStyle}" Margin="4,0">
                                                    <StackPanel>
                                                        <TextBlock Text="Top 10" FontSize="12" Foreground="Gray"/>
                                                        <TextBlock Text="{Binding CurrentDailySalesForTop10}" 
                                                                  FontSize="20" FontWeight="Bold"/>
                                                        <TextBlock Text="daily sales" FontSize="10" Foreground="Gray"/>
                                                    </StackPanel>
                                                </Border>
                                                
                                                <Border Grid.Column="2" Style="{DynamicResource MetricTileStyle}" Margin="4,0,0,0">
                                                    <StackPanel>
                                                        <TextBlock Text="Top 50" FontSize="12" Foreground="Gray"/>
                                                        <TextBlock Text="{Binding CurrentDailySalesForTop50}" 
                                                                  FontSize="20" FontWeight="Bold"/>
                                                        <TextBlock Text="daily sales" FontSize="10" Foreground="Gray"/>
                                                    </StackPanel>
                                                </Border>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                    <!-- Revenue Projections -->
                                    <Border Style="{DynamicResource ChartContainerStyle}" Margin="0,0,0,16">
                                        <StackPanel>
                                            <TextBlock Text="💰 Revenue Projections" FontWeight="Bold" Margin="0,0,0,8"/>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <Border Grid.Column="0" Style="{DynamicResource MetricTileStyle}" Margin="0,0,8,0">
                                                    <StackPanel>
                                                        <TextBlock Text="At Bestseller (#1)" FontSize="12" Foreground="Gray"/>
                                                        <TextBlock Text="{Binding MonthlyRevenueAtBestseller, StringFormat=C0}" 
                                                                  FontSize="18" FontWeight="Bold"/>
                                                        <TextBlock Text="monthly revenue" FontSize="10" Foreground="Gray"/>
                                                    </StackPanel>
                                                </Border>
                                                
                                                <Border Grid.Column="1" Style="{DynamicResource MetricTileStyle}" Margin="8,0,0,0">
                                                    <StackPanel>
                                                        <TextBlock Text="At Top 10" FontSize="12" Foreground="Gray"/>
                                                        <TextBlock Text="{Binding MonthlyRevenueAtTop10, StringFormat=C0}" 
                                                                  FontSize="18" FontWeight="Bold"/>
                                                        <TextBlock Text="monthly revenue" FontSize="10" Foreground="Gray"/>
                                                    </StackPanel>
                                                </Border>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                    <!-- Success Analysis -->
                                    <Border Style="{DynamicResource ChartContainerStyle}" Margin="0,0,0,16">
                                        <StackPanel>
                                            <TextBlock Text="🎲 Success Probability" FontWeight="Bold" Margin="0,0,0,8"/>
                                            <ProgressBar Value="{Binding SuccessProbability}" Maximum="1" Height="20" Margin="0,0,0,8"/>
                                            <TextBlock Text="{Binding SuccessProbability, StringFormat=P1}" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center"/>
                                            <TextBlock Text="{Binding RecommendedStrategy}" TextWrapping="Wrap" Margin="0,8,0,0"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- Timing Optimization -->
                                    <Border Style="{DynamicResource ChartContainerStyle}" Margin="0,0,0,16">
                                        <StackPanel>
                                            <TextBlock Text="📅 Optimal Release Timing" FontWeight="Bold" Margin="0,0,0,8"/>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="Easiest Month:" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding EasiestMonth}" FontSize="16" FontWeight="Bold"/>
                                                </StackPanel>
                                                
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="Days Until Optimal:" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding DaysUntilEasiestPeriod}" FontSize="16" FontWeight="Bold"/>
                                                </StackPanel>
                                            </Grid>
                                        </StackPanel>
                                    </Border>

                                    <!-- Action Items -->
                                    <Border Style="{DynamicResource ChartContainerStyle}">
                                        <StackPanel>
                                            <TextBlock Text="✅ Recommended Action Items" FontWeight="Bold" Margin="0,0,0,8"/>
                                            <ItemsControl ItemsSource="{Binding ActionItems}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                                            <TextBlock Text="• " FontWeight="Bold"/>
                                                            <TextBlock Text="{Binding}" TextWrapping="Wrap"/>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ContentControl.ContentTemplate>
                    </ContentControl>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Status Bar -->
        <DockPanel Grid.Row="3" LastChildFill="True" Margin="0,8,0,0">
            <ProgressBar DockPanel.Dock="Left" IsIndeterminate="{Binding IsSearching}" 
                        Width="200" Height="20" Margin="0,0,16,0"/>
            <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                <Button Content="📤 Export" Command="{Binding ExportRecommendationsCommand}" 
                       Style="{DynamicResource MahApps.Styles.Button.Square}" Margin="8,0"/>
                <Button Content="🗑️ Clear" Command="{Binding ClearResultsCommand}" 
                       Style="{DynamicResource MahApps.Styles.Button.Square}" Margin="8,0,0,0"/>
            </StackPanel>
        </DockPanel>
    </Grid>
</UserControl>